#!/usr/bin/with-contenv bash
# shellcheck shell=bash

umask "${UMASK}"

echo "
----------------------------------------------------------------------
ENVIRONMENT
----------------------------------------------------------------------
PUID=${PUID}
PGID=${PGID}
UMASK=${UMASK}
TZ=${TZ}
PLEX_CLAIM=${PLEX_CLAIM}
ADVERTISE_IP=${ADVERTISE_IP}
ALLOWED_NETWORKS=${ALLOWED_NETWORKS}
PLEX_PASS=${PLEX_PASS}
----------------------------------------------------------------------
"

if [[ ! "${PUID}" -eq 0 ]] && [[ ! "${PGID}" -eq 0 ]]; then
    echo "Executing usermod..."
    mkdir "/tmp/temphome"
    usermod -d "/tmp/temphome" hotio
    usermod -o -u "${PUID}" hotio
    usermod -d "${CONFIG_DIR}" hotio
    rm -rf "/tmp/temphome"
    groupmod -o -g "${PGID}" hotio
else
    echo "Running as root is not supported, please fix your PUID and PGID!"
    exit 1
fi

echo "Applying permissions to ${CONFIG_DIR}"
chmod "=rwx" "${CONFIG_DIR}"
chown hotio:hotio "${CONFIG_DIR}"

echo "Applying permissions to /transcode"
chmod "=rwx" "/transcode"
chown hotio:hotio "/transcode"

if [[ -d "${CONFIG_DIR}/app/Plex Media Server" ]]; then
    if [[ -n "$(ls -A "${CONFIG_DIR}/app/Plex Media Server")" ]]; then
        echo "Migrating files from \"${CONFIG_DIR}/app/Plex Media Server\" to \"${CONFIG_DIR}\"..."
        shopt -s dotglob
        mv -f "${CONFIG_DIR}/app/Plex Media Server/"* "${CONFIG_DIR}" > /dev/null 2>&1 && rmdir "${CONFIG_DIR}/app/Plex Media Server" && rmdir "${CONFIG_DIR}/app"
        shopt -u dotglob
    fi
fi
